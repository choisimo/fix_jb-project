import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
// import 'package:image_picker/image_picker.dart';  // ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬
import 'dart:io';
import '../../../../core/auth/auth_service.dart';
import '../../../../core/theme/theme_manager.dart';
import '../../../../core/profile/profile_service.dart';
// import '../../../../core/utils/image_utils.dart';  // ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬
import '../../../../app/routes/app_routes.dart';
import 'my_reports_page.dart';
import 'notification_settings_page.dart';
import 'help_page.dart';
import 'app_info_page.dart';
import 'settings_page.dart';

class ProfilePage extends StatefulWidget {
  const ProfilePage({super.key});

  @override
  State<ProfilePage> createState() => _ProfilePageState();
}

class _ProfilePageState extends State<ProfilePage> {
  // final ImagePicker _picker = ImagePicker();  // ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬
  File? _profileImage;
  String? _profileImageUrl;
  bool _isUploading = false;

  @override
  void initState() {
    super.initState();
    // _loadProfileImage(); // ì„ì‹œë¡œ ë¹„í™œì„±í™” - ì„œë²„ ì—°ê²° ë¬¸ì œë¡œ ì¸í•œ ì˜¤ë¥˜ ë°©ì§€
  }

  /// ì„œë²„ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ URL ë¡œë“œ
  // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ - ë°±ì—”ë“œ ì—°ê²° ì‹œ í™œì„±í™” ì˜ˆì •
  /*
  Future<void> _loadProfileImage() async {
    try {
      // TODO: ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ í›„ ì£¼ì„ í•´ì œ
      /*
      final imageUrl = await ProfileService.instance.getProfileImageUrl();
      if (mounted) {
        setState(() {
          _profileImageUrl = imageUrl;
        });
      }
      */
      print('ğŸ”§ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë”© ì„ì‹œ ë¹„í™œì„±í™” - ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘');
    } catch (e) {
      // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
      print('âš ï¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('í”„ë¡œí•„'),
        actions: [
          IconButton(
            icon: const Icon(Icons.settings),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const SettingsPage()),
              );
            },
          ),
        ],
      ),
      body: Builder(
        builder: (context) {
          final authService = AuthService.instance;
          final userInfo = authService.userInfo;

          return SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                Card(
                  child: Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      children: [
                        GestureDetector(
                          onTap: _showImageSourceDialog,
                          child: Stack(
                            children: [
                              CircleAvatar(
                                radius: 50,
                                backgroundImage: _getProfileImage(),
                                child: _getProfileImage() == null
                                    ? const Icon(Icons.person, size: 50)
                                    : null,
                              ),
                              if (_isUploading)
                                Positioned.fill(
                                  child: CircleAvatar(
                                    radius: 50,
                                    backgroundColor: Colors.black54,
                                    child: const CircularProgressIndicator(
                                      color: Colors.white,
                                    ),
                                  ),
                                ),
                              Positioned(
                                bottom: 0,
                                right: 0,
                                child: Container(
                                  decoration: BoxDecoration(
                                    color: Theme.of(context).primaryColor,
                                    shape: BoxShape.circle,
                                  ),
                                  padding: const EdgeInsets.all(8),
                                  child: const Icon(
                                    Icons.camera_alt,
                                    color: Colors.white,
                                    size: 16,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 16),
                        Text(
                          userInfo?['name'] ?? 'ì‚¬ìš©ì',
                          style: const TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          userInfo?['email'] ?? '',
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          userInfo?['department'] ?? 'ë¶€ì„œ ì •ë³´ ì—†ìŒ',
                          style: TextStyle(
                            fontSize: 14,
                            color: Colors.grey[600],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 16),
                Card(
                  child: Column(
                    children: [
                      ListTile(
                        leading: const Icon(Icons.assignment),
                        title: const Text('ë‚´ ë³´ê³ ì„œ'),
                        trailing: const Icon(Icons.arrow_forward_ios),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const MyReportsPage(),
                            ),
                          );
                        },
                      ),
                      const Divider(height: 1),
                      ListTile(
                        leading: const Icon(Icons.notifications),
                        title: const Text('ì•Œë¦¼ ì„¤ì •'),
                        trailing: const Icon(Icons.arrow_forward_ios),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) =>
                                  const NotificationSettingsPage(),
                            ),
                          );
                        },
                      ),
                      const Divider(height: 1),
                      ListTile(
                        leading: const Icon(Icons.help),
                        title: const Text('ë„ì›€ë§'),
                        trailing: const Icon(Icons.arrow_forward_ios),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const HelpPage(),
                            ),
                          );
                        },
                      ),
                      const Divider(height: 1),
                      ListTile(
                        leading: const Icon(Icons.info),
                        title: const Text('ì•± ì •ë³´'),
                        trailing: const Icon(Icons.arrow_forward_ios),
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const AppInfoPage(),
                            ),
                          );
                        },
                      ),
                      const Divider(height: 1),
                      // ê°œë°œì ë„êµ¬ (ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ)
                      if (kDebugMode) ...[
                        ListTile(
                          leading: const Icon(Icons.developer_mode, color: Colors.orange),
                          title: const Text('ìœ„ì¹˜ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸'),
                          subtitle: const Text('GPS/ìœ„ì¹˜ ê¸°ëŠ¥ ë””ë²„ê¹…'),
                          trailing: const Icon(Icons.arrow_forward_ios),
                          onTap: () {
                            Navigator.pushNamed(context, '/location-test');
                          },
                        ),
                      ],
                    ],
                  ),
                ),
                const SizedBox(height: 16),
                Card(
                  child: ListTile(
                    leading: const Icon(Icons.logout, color: Colors.red),
                    title: const Text(
                      'ë¡œê·¸ì•„ì›ƒ',
                      style: TextStyle(color: Colors.red),
                    ),
                    onTap: () async {
                      final confirmed = await showDialog<bool>(
                        context: context,
                        builder: (context) => AlertDialog(
                          title: const Text('ë¡œê·¸ì•„ì›ƒ'),
                          content: const Text('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.of(context).pop(false),
                              child: const Text('ì·¨ì†Œ'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.of(context).pop(true),
                              child: const Text('ë¡œê·¸ì•„ì›ƒ'),
                            ),
                          ],
                        ),
                      );

                      if (confirmed == true) {
                        await authService.logout();
                        if (context.mounted) {
                          Navigator.of(context).pushNamedAndRemoveUntil(
                            AppRoutes.login,
                            (route) => false,
                          );
                        }
                      }
                    },
                  ),
                ),
                const SizedBox(height: 16),

                // í˜„ì¬ ì„¤ì • ìƒíƒœ í‘œì‹œ ì¹´ë“œ
                AnimatedBuilder(
                  animation: ThemeManager.instance,
                  builder: (context, child) {
                    return Card(
                      child: Padding(
                        padding: const EdgeInsets.all(16),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.settings_applications,
                                  color: Theme.of(context).primaryColor,
                                ),
                                const SizedBox(width: 8),
                                const Text(
                                  'í˜„ì¬ ì„¤ì •',
                                  style: TextStyle(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 12),
                            _buildSettingRow(
                              icon: Icons.brightness_6,
                              title: 'í…Œë§ˆ',
                              value: ThemeManager.instance.isDarkMode
                                  ? 'ë‹¤í¬ëª¨ë“œ'
                                  : 'ë¼ì´íŠ¸ëª¨ë“œ',
                              iconColor: ThemeManager.instance.isDarkMode
                                  ? Colors.grey[700]
                                  : Colors.yellow[700],
                            ),
                            _buildSettingRow(
                              icon: Icons.text_fields,
                              title: 'í°íŠ¸ í¬ê¸°',
                              value:
                                  '${ThemeManager.instance.fontSize.toInt()}px',
                              iconColor: Colors.blue,
                            ),
                            _buildSettingRow(
                              icon: Icons.language,
                              title: 'ì–¸ì–´',
                              value: ThemeManager.instance.language,
                              iconColor: Colors.green,
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
                const SizedBox(height: 16),
              ],
            ),
          );
        },
      ),
    );
  }

  /// ì„¤ì • í•­ëª©ì„ í‘œì‹œí•˜ëŠ” ìœ„ì ¯
  Widget _buildSettingRow({
    required IconData icon,
    required String title,
    required String value,
    Color? iconColor,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4.0),
      child: Row(
        children: [
          Icon(icon, size: 20, color: iconColor ?? Colors.grey[600]),
          const SizedBox(width: 12),
          Text(
            title,
            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.w500),
          ),
          const Spacer(),
          Text(
            value,
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[600],
              fontWeight: FontWeight.w400,
            ),
          ),
        ],
      ),
    );
  }

  /// ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
  void _showImageSourceDialog() {
    showModalBottomSheet(
      context: context,
      builder: (BuildContext context) {
        return SafeArea(
          child: Wrap(
            children: [
              ListTile(
                leading: const Icon(Icons.photo_camera),
                title: const Text('ì¹´ë©”ë¼ë¡œ ì´¬ì˜'),
                onTap: () {
                  Navigator.of(context).pop();
                  _pickImageFromCamera();
                },
              ),
              ListTile(
                leading: const Icon(Icons.photo_library),
                title: const Text('ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ'),
                onTap: () {
                  Navigator.of(context).pop();
                  _pickImageFromGallery();
                },
              ),
              if (_profileImage != null)
                ListTile(
                  leading: const Icon(Icons.delete),
                  title: const Text('ì‚¬ì§„ ì‚­ì œ'),
                  onTap: () {
                    Navigator.of(context).pop();
                    _removeProfileImage();
                  },
                ),
            ],
          ),
        );
      },
    );
  }

  /// ì¹´ë©”ë¼ì—ì„œ ì´ë¯¸ì§€ ì„ íƒ
  Future<void> _pickImageFromCamera() async {
    try {
      // TODO: ImagePickerê°€ í•´ê²°ë˜ë©´ ì£¼ì„ í•´ì œ
      /*
      final image = await _picker.pickImage(
        source: ImageSource.camera,
        maxWidth: 800,
        maxHeight: 800,
        imageQuality: 85,
      );
      
      if (image != null) {
        final File imageFile = File(image.path);
        
        // íŒŒì¼ í¬ê¸° ê²€ì‚¬
        if (await ImageUtils.isFileSizeValid(imageFile)) {
          setState(() {
            _profileImage = imageFile;
            _profileImageUrl = null; // ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ ìš°ì„  í‘œì‹œ
          });
          await _uploadProfileImage(imageFile);
        } else {
          _showErrorSnackBar('ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
      }
      */
      _showErrorSnackBar('ì´ë¯¸ì§€ ì„ íƒ ê¸°ëŠ¥ì´ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    } catch (e) {
      _showErrorSnackBar('ì¹´ë©”ë¼ì—ì„œ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  /// ê°¤ëŸ¬ë¦¬ì—ì„œ ì´ë¯¸ì§€ ì„ íƒ
  Future<void> _pickImageFromGallery() async {
    try {
      // TODO: ImagePickerê°€ í•´ê²°ë˜ë©´ ì£¼ì„ í•´ì œ
      /*
      final image = await _picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 800,
        maxHeight: 800,
        imageQuality: 85,
      );
      
      if (image != null) {
        final File imageFile = File(image.path);
        
        // íŒŒì¼ í¬ê¸° ê²€ì‚¬
        if (await ImageUtils.isFileSizeValid(imageFile)) {
          setState(() {
            _profileImage = imageFile;
            _profileImageUrl = null; // ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ ìš°ì„  í‘œì‹œ
          });
          await _uploadProfileImage(imageFile);
        } else {
          _showErrorSnackBar('ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
      }
      */
      _showErrorSnackBar('ì´ë¯¸ì§€ ì„ íƒ ê¸°ëŠ¥ì´ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    } catch (e) {
      _showErrorSnackBar('ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  /// í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚­ì œ
  void _removeProfileImage() {
    setState(() {
      _profileImage = null;
      _profileImageUrl = null;
    });
    _deleteProfileImageFromServer();
  }

  /// ì„œë²„ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚­ì œ
  Future<void> _deleteProfileImageFromServer() async {
    try {
      await ProfileService.instance.deleteProfileImage();
      _showSuccessSnackBar('í”„ë¡œí•„ ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (e) {
      _showErrorSnackBar('í”„ë¡œí•„ ì‚¬ì§„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  /// í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  Future<void> _uploadProfileImage(File imageFile) async {
    setState(() {
      _isUploading = true;
    });

    try {
      final result = await ProfileService.instance.uploadProfileImage(
        imageFile,
      );
      final newImageUrl = result['imageUrl'] as String?;

      setState(() {
        _profileImageUrl = newImageUrl;
        _profileImage = null; // ì—…ë¡œë“œ ì„±ê³µ í›„ ì„œë²„ ì´ë¯¸ì§€ë¥¼ ìš°ì„  í‘œì‹œ
      });

      _showSuccessSnackBar('í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (e) {
      _showErrorSnackBar(e.toString().replaceAll('Exception: ', ''));
      // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì´ë¯¸ì§€ë„ ì œê±°
      setState(() {
        _profileImage = null;
      });
    } finally {
      setState(() {
        _isUploading = false;
      });
    }
  }

  /// ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
  void _showSuccessSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
  void _showErrorSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// í”„ë¡œí•„ ì´ë¯¸ì§€ ë°˜í™˜ (ë¡œì»¬ íŒŒì¼ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì´ë¯¸ì§€)
  ImageProvider? _getProfileImage() {
    if (_profileImage != null) {
      return FileImage(_profileImage!);
    } else if (_profileImageUrl != null && _profileImageUrl!.isNotEmpty) {
      return NetworkImage(_profileImageUrl!);
    }
    return null;
  }
  */
}
